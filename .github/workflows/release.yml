name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  create-release-body:
    name: create-release-body
    runs-on: ubuntu-latest
    outputs:
      release_body_path: ${{ steps.generate_body.outputs.path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to fetch all history for changelog generation

      - name: Generate release body
        id: generate_body
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the previous tag, or the first commit if there's no previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)

          # Fetch commit data from GitHub API's compare endpoint
          API_URL="https://api.github.com/repos/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ github.ref_name }}"
          COMMIT_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "$API_URL")

          # Generate changelog from API data using jq
          CHANGELOG=$(echo "$COMMIT_DATA" | jq -r '
            .commits | .[] |
            .commit.message as $message |
            .author.login as $author |
            .sha as $sha |
            .html_url as $url |
            "* \($message | split("\n")[0]) | [\($sha | .[:7])](\($url))" +
            (if $author and $author != "" and $author != "null" then " by [@\($author)](https://github.com/\($author))" else "" end)
          ')

          # Generate contributors list from the same API data
          USERS_DATA=$(echo "$COMMIT_DATA" | jq -r '.commits | .[] | .author | "\(.login) \(.id)"' | sort -u)
          CONTRIBUTORS_LIST=""
          while read -r login id; do
            if [ -n "$login" ] && [ "$login" != "null" ]; then
              avatar_url="https://avatars.githubusercontent.com/u/${id}?s=32&v=4"
              CONTRIBUTORS_LIST="${CONTRIBUTORS_LIST} <a href=\"https://github.com/${login}\"><img src=\"${avatar_url}\" width=\"32\" height=\"32\" alt=\"${login}\"/></a>"
            fi
          done <<< "$USERS_DATA"
          CONTRIBUTOR_COUNT=$(echo "$USERS_DATA" | wc -l | xargs)

          # Construct the compare URL
          COMPARE_URL="https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG..${{ github.ref_name }}"

          # Create the release body content
          BODY_CONTENT=$(cat <<-EOF
          ## What's changed in ${{ github.ref_name }}

          ### Description

          Pending.

          ### Changelog

          $CHANGELOG

          [$PREVIOUS_TAG -> ${{ github.ref_name }}]($COMPARE_URL)

          ### Contributors

          ${CONTRIBUTORS_LIST}

          ${CONTRIBUTOR_COUNT} contributor(s)
          EOF
          )

          # Save the body to a file and output its path
          RELEASE_BODY_FILE="RELEASE_BODY.md"
          echo "$BODY_CONTENT" > $RELEASE_BODY_FILE
          echo "path=$RELEASE_BODY_FILE" >> $GITHUB_OUTPUT

      - name: Upload release body artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-body
          path: ${{ steps.generate_body.outputs.path }}

  build-release:
    permissions:
      contents: write
    name: build-release
    needs: create-release-body
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate Lockfile
        run: cargo generate-lockfile

      - name: Build binary
        run: cargo build --release --locked

      - name: Package binary
        shell: bash
        run: |
          # The binary name generated by cargo (from crates/tonic-music-cli/Cargo.toml)
          COMPILED_BINARY_NAME="tonic-music-cli"
          # The name we want to distribute to users
          DIST_BINARY_NAME="tonic-music"
          
          TARGET_DIR="target/release"
          ASSET_NAME="${DIST_BINARY_NAME}-${{ runner.os }}"

          if [ "${{ runner.os }}" = "Windows" ]; then
            mv "${TARGET_DIR}/${COMPILED_BINARY_NAME}.exe" "${ASSET_NAME}.exe"
            echo "ASSET_PATH=${ASSET_NAME}.exe" >> $GITHUB_ENV
          else
            # Rename the binary to the user-friendly name before tarring
            cp "${TARGET_DIR}/${COMPILED_BINARY_NAME}" "${DIST_BINARY_NAME}"
            tar -czf "${ASSET_NAME}.tar.gz" "${DIST_BINARY_NAME}"
            echo "ASSET_PATH=${ASSET_NAME}.tar.gz" >> $GITHUB_ENV
          fi

      - name: Upload release assets artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ runner.os }}
          path: ${{ env.ASSET_PATH }}

  create-tag-and-release:
    permissions:
      contents: write
    name: create-tag-and-release
    needs: [create-release-body, build-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body_path: "artifacts/release-body/RELEASE_BODY.md"
          files: |
            artifacts/release-assets-Linux/tonic-music-Linux.tar.gz
            artifacts/release-assets-macOS/tonic-music-macOS.tar.gz
            artifacts/release-assets-Windows/tonic-music-Windows.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}