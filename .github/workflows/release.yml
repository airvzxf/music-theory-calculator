name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

jobs:
  create-release-body:
    name: create-release-body
    runs-on: ubuntu-latest
    outputs:
      release_body_path: ${{ steps.generate_body.outputs.path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to fetch all history for changelog generation

      - name: Generate release body
        id: generate_body
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the previous tag, or the first commit if there's no previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || git rev-list --max-parents=0 HEAD)

          # Fetch commit data from GitHub API's compare endpoint
          API_URL="https://api.github.com/repos/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ github.ref_name }}"
          COMMIT_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "$API_URL")

          # Generate changelog from API data using jq
          CHANGELOG=$(echo "$COMMIT_DATA" | jq -r '
            .commits | .[] |
            .commit.message as $message |
            .author.login as $author |
            .sha as $sha |
            .html_url as $url |
            "* \($message | split("\n")[0]) | [\($sha | .[:7])](\($url))" +
            (if $author and $author != "" and $author != "null" then " by [@\($author)](https://github.com/\($author))" else "" end)
          ')

          # Generate contributors list from the same API data
          USERS_DATA=$(echo "$COMMIT_DATA" | jq -r '.commits | .[] | .author | "\(.login) \(.id)"' | sort -u)
          CONTRIBUTORS_LIST=""
          while read -r login id; do
            if [ -n "$login" ] && [ "$login" != "null" ]; then
              avatar_url="https://avatars.githubusercontent.com/u/${id}?s=32&v=4"
              CONTRIBUTORS_LIST="${CONTRIBUTORS_LIST} <a href=\"https://github.com/${login}\"><img src=\"${avatar_url}\" width=\"32\" height=\"32\" alt=\"${login}\"/></a>"
            fi
          done <<< "$USERS_DATA"
          CONTRIBUTOR_COUNT=$(echo "$USERS_DATA" | wc -l | xargs)

          # Construct the compare URL
          COMPARE_URL="https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG..${{ github.ref_name }}"

          # Create the release body content
          BODY_CONTENT=$(cat <<-EOF
          ## What's changed in ${{ github.ref_name }}

          ### Description

          Pending.

          ### Changelog

          $CHANGELOG

          [$PREVIOUS_TAG -> ${{ github.ref_name }}]($COMPARE_URL)

          ### Contributors

          ${CONTRIBUTORS_LIST}

          ${CONTRIBUTOR_COUNT} contributor(s)
          EOF
          )

          # Save the body to a file and output its path
          RELEASE_BODY_FILE="RELEASE_BODY.md"
          echo "$BODY_CONTENT" > $RELEASE_BODY_FILE
          echo "path=$RELEASE_BODY_FILE" >> $GITHUB_OUTPUT

      - name: Upload release body artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-body
          path: ${{ steps.generate_body.outputs.path }}

  build-release:
    permissions:
      contents: write
    name: build-release
    needs: create-release-body
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Calculate Cargo.lock hash
        id: cargo-lock-hash
        shell: bash
        run: echo "hash=$(git hash-object Cargo.lock)" >> $GITHUB_OUTPUT

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ steps.cargo-lock-hash.outputs.hash }}

      - name: Generate Lockfile
        run: cargo generate-lockfile

      - name: Build binary
        run: cargo build --release --locked

      - name: Package binary
        shell: bash
        run: |
          # The binary name generated by cargo (from crates/tonic-music-cli/Cargo.toml)
          COMPILED_BINARY_NAME="tonic-music-cli"
          # The name we want to distribute to users
          DIST_BINARY_NAME="tonic-music"

          TARGET_DIR="target/release"
          ASSET_NAME="${DIST_BINARY_NAME}-${{ runner.os }}"

          if [ "${{ runner.os }}" = "Windows" ]; then
            mv "${TARGET_DIR}/${COMPILED_BINARY_NAME}.exe" "${ASSET_NAME}.exe"
            echo "ASSET_PATH=${ASSET_NAME}.exe" >> $GITHUB_ENV
          else
            # Rename the binary to the user-friendly name before tarring
            cp "${TARGET_DIR}/${COMPILED_BINARY_NAME}" "${DIST_BINARY_NAME}"
            tar -czf "${ASSET_NAME}.tar.gz" "${DIST_BINARY_NAME}"
            echo "ASSET_PATH=${ASSET_NAME}.tar.gz" >> $GITHUB_ENV
          fi

      - name: Upload release assets artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ runner.os }}
          path: ${{ env.ASSET_PATH }}

  build-wasm-release:
    name: build-wasm-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build Wasm
        working-directory: crates/tonic-music-wasm
        run: wasm-pack build --target web

      - name: Package Web Artifacts
        shell: bash
        run: |
          mkdir -p tonic-music-web
          cp crates/tonic-music-wasm/index.html tonic-music-web/
          cp -r crates/tonic-music-wasm/pkg tonic-music-web/

          tar -czf tonic-music-web.tar.gz tonic-music-web
          echo "ASSET_PATH=tonic-music-web.tar.gz" >> $GITHUB_ENV

      - name: Upload web assets artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-assets
          path: ${{ env.ASSET_PATH }}

  build-android-release:
    name: build-android-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android armv7-linux-androideabi x86_64-linux-android

      - name: Calculate Cargo.lock hash
        id: cargo-lock-hash
        shell: bash
        run: echo "hash=$(git hash-object Cargo.lock)" >> $GITHUB_OUTPUT
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-android-cargo-${{ steps.cargo-lock-hash.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-android-cargo-

      - name: Cache cargo-ndk
        id: cache-cargo-ndk
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-ndk
          key: ${{ runner.os }}-cargo-ndk-v4.1.2
      - name: Install cargo-ndk
        if: steps.cache-cargo-ndk.outputs.cache-hit != 'true'
        run: cargo install cargo-ndk --version 4.1.2

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Generate Bindings & Libs
        run: ./scripts/generate_bindings.sh

      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > apps/android/app/release.jks

      - name: Build Android Release
        working-directory: apps/android
        env:
          ANDROID_KEYSTORE_FILE: ${{ github.workspace }}/apps/android/app/release.jks
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: ./gradlew assembleRelease bundleRelease

      - name: Upload Android Release Assets
        uses: actions/upload-artifact@v4
        with:
          name: android-release-assets
          path: |
            apps/android/app/build/outputs/apk/release/app-release.apk
            apps/android/app/build/outputs/bundle/release/app-release.aab

  create-tag-and-release:
    permissions:
      contents: write
    name: create-tag-and-release
    needs: [create-release-body, build-release, build-wasm-release, build-android-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body_path: "artifacts/release-body/RELEASE_BODY.md"
          files: |
            artifacts/release-assets-Linux/tonic-music-Linux.tar.gz
            artifacts/release-assets-macOS/tonic-music-macOS.tar.gz
            artifacts/release-assets-Windows/tonic-music-Windows.exe
            artifacts/web-assets/tonic-music-web.tar.gz
            artifacts/android-release-assets/app-release.apk
            artifacts/android-release-assets/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
